import numpy as np
from binance.spot import Spot
import pandas as pd
import datetime
from datetime import timedelta


def calculate_rsi(df_calculate, cycle):
    """
    计算对应代币一段时间的rsi
    :param df_calculate:
    :param cycle:
    :return:
    """
    df_calculate['rsi'] = np.zeros(len(df_calculate.index))
    for i in range(cycle - 1, len(df_calculate.index)):
        gain = 0.0
        gain_count = 0
        loss = 0.0
        loss_count = 0
        for j in range(i - cycle + 2, i + 1):
            if float(df_calculate.iloc[j]['close']) > float(df_calculate.iloc[j - 1]['close']):
                gain += float(df_calculate.iloc[j]['close']) - float(df_calculate.iloc[j - 1]['close'])
                gain_count += 1
            else:
                loss += float(df_calculate.iloc[j - 1]['close']) - float(df_calculate.iloc[j]['close'])
                loss_count += 1
        rs = 0.0
        rsi = 0.0
        if loss != 0.0 and gain != 0.0:
            rs = (gain * loss_count) / (loss * gain_count)
            rsi = 100 - 100.0 / (1 + rs)
        elif loss == 0.0:
            rsi = 100
        elif gain == 0.0:
            rsi = 0
        df_calculate.loc[i, 'rsi'] = rsi
    return df.drop(range(cycle), axis=0).reset_index(drop=True)


def hit_feature(df_hit):
    """
    是否命中特征
    :param df_hit:
    :return:
    """
    current_low_price = float(df_hit.iloc[len(df_hit.index) - 1]['low'])
    current_rsi = df_hit.iloc[len(df_hit.index) - 1]['rsi']
    for i in range(0, len(df_hit.index) - 1):
        if float(df_hit.iloc[i]['low']) < current_low_price:
            return False
    for i in range(0, len(df_hit.index) - 1):
        if df_hit.iloc[i]['rsi'] < current_rsi:
            return True
    return False


if __name__ == '__main__':
    client = Spot(base_url='https://api4.binance.com')
    symbols = ['BTCUSDT', 'ETHUSDT']
    for symbol in symbols:
        rsi_calculate_cycle = 6
        coin_cycle = 42
        current_time = datetime.datetime.now()
        startTime = int(datetime.datetime.strptime(
            (current_time - timedelta(hours=coin_cycle + rsi_calculate_cycle)).strftime('%Y-%m-%d %H'),
            '%Y-%m-%d %H').timestamp() * 1000)
        endTime = int(datetime.datetime.now().timestamp() * 1000)
        interval = '1h'
        # kline = client.klines(symbol=symbol, interval=interval, startTime=startTime, endTime=endTime)
        kline = [[1722085200000, '68400.00000000', '69385.06000000', '68399.99000000', '69226.01000000', '2533.40815000', 1722088799999, '174642187.32373580', 127157, '1563.59130000', '107765240.32292870', '0'],[1722088800000, '69226.01000000', '69399.99000000', '68794.46000000', '68981.69000000', '1478.17223000', 1722092399999, '102090085.85565020', 83573, '711.64625000', '49143079.40649000', '0'],[1722092400000, '68981.69000000', '69086.00000000', '68583.69000000', '68844.00000000', '1218.54970000', 1722095999999, '83843125.59051870', 76008, '619.43527000', '42626498.66071100', '0'], [1722096000000, '68844.00000000', '68979.32000000', '68644.00000000', '68684.01000000', '610.23017000', 1722099599999, '42003232.44444400', 45676, '280.23556000', '19291520.97278520', '0'], [1722099600000, '68684.01000000', '68754.34000000', '68428.18000000', '68540.01000000', '821.17611000', 1722103199999, '56300413.18981360', 53299, '386.79096000', '26517818.91350390', '0'], [1722103200000, '68540.00000000', '68990.03000000', '68508.12000000', '68542.76000000', '841.42652000', 1722106799999, '57854964.94160960', 57135, '370.39181000', '25470378.84929490', '0'], [1722106800000, '68542.76000000', '68641.53000000', '67658.68000000', '68246.00000000', '2998.73711000', 1722110399999, '204493355.26516030', 155254, '1384.43871000', '94390355.84652510', '0'], [1722110400000, '68246.00000000', '68450.00000000', '66650.00000000', '67791.22000000', '9441.78954000', 1722113999999, '637769042.41597360', 429099, '4666.75114000', '315334034.30875550', '0'], [1722114000000, '67791.21000000', '69182.94000000', '67596.00000000', '68860.00000000', '3685.95466000', 1722117599999, '252833897.52647320', 164244, '2031.29254000', '139336536.99944330', '0'], [1722117600000, '68860.01000000', '68860.01000000', '68502.60000000', '68619.97000000', '676.67595000', 1722121199999, '46476638.87540660', 41817, '311.00828000', '21362009.70688910', '0'], [1722121200000, '68619.97000000', '68619.97000000', '67749.50000000', '67896.50000000', '1142.99300000', 1722124799999, '77884363.97798970', 65262, '478.51477000', '32605839.10251650', '0'], [1722124800000, '67896.49000000', '68083.35000000', '67260.54000000', '67958.00000000', '1184.21920000', 1722128399999, '80234207.85148360', 79279, '558.68624000', '37856816.02767970', '0'], [1722128400000, '67958.00000000', '68285.43000000', '67916.00000000', '68090.01000000', '483.06066000', 1722131999999, '32901282.95736410', 32990, '241.10416000', '16423058.26613950', '0'], [1722132000000, '68090.01000000', '68149.45000000', '67966.00000000', '68149.45000000', '260.89082000', 1722135599999, '17756499.28736600', 19766, '125.78011000', '8560179.19589560', '0'], [1722135600000, '68149.44000000', '68149.45000000', '67940.94000000', '67940.95000000', '287.53753000', 1722139199999, '19565368.15650000', 20196, '102.12059000', '6948701.66413340', '0'], [1722139200000, '67940.94000000', '68024.18000000', '67300.00000000', '67338.00000000', '750.45729000', 1722142799999, '50804344.80927390', 41120, '297.93790000', '20166811.19708070', '0'], [1722142800000, '67338.00000000', '67500.00000000', '67066.66000000', '67422.00000000', '765.53150000', 1722146399999, '51506853.93508480', 51890, '363.89176000', '24488050.29760020', '0'], [1722146400000, '67422.01000000', '67590.82000000', '67386.00000000', '67486.01000000', '363.16586000', 1722149999999, '24507950.96359930', 26509, '196.39530000', '13254059.58082250', '0'], [1722150000000, '67486.00000000', '67560.86000000', '67309.15000000', '67560.86000000', '519.16465000', 1722153599999, '35006691.53587580', 24702, '295.94621000', '19957886.30870270', '0'], [1722153600000, '67560.86000000', '67564.48000000', '67220.00000000', '67380.00000000', '403.65485000', 1722157199999, '27204790.81060010', 25712, '192.92502000', '13002077.93522540', '0'], [1722157200000, '67380.00000000', '67550.28000000', '67329.60000000', '67433.65000000', '254.57758000', 1722160799999, '17170111.48645400', 22327, '144.84285000', '9769366.97454520', '0'], [1722160800000, '67433.65000000', '67686.39000000', '67390.34000000', '67560.01000000', '441.61158000', 1722164399999, '29851477.82232050', 27823, '250.49992000', '16934230.43106870', '0'], [1722164400000, '67560.01000000', '68000.00000000', '67560.01000000', '67836.00000000', '671.09227000', 1722167999999, '45512716.46216950', 38417, '415.88820000', '28206089.81539560', '0'], [1722168000000, '67836.01000000', '68123.32000000', '67745.46000000', '68000.01000000', '530.60556000', 1722171599999, '36055801.53140000', 39612, '298.81033000', '20306325.66261130', '0'], [1722171600000, '68000.01000000', '68044.01000000', '67861.27000000', '67988.01000000', '309.86124000', 1722175199999, '21058926.36992640', 25978, '157.76899000', '10722113.71231870', '0'], [1722175200000, '67988.01000000', '68024.99000000', '67634.70000000', '67746.00000000', '602.61210000', 1722178799999, '40866793.38403780', 42926, '284.78582000', '19315319.23611420', '0'], [1722178800000, '67746.00000000', '67777.77000000', '67577.63000000', '67645.00000000', '325.75611000', 1722182399999, '22045798.69396930', 34298, '139.66477000', '9451461.96623660', '0'], [1722182400000, '67645.00000000', '67753.26000000', '67624.00000000', '67680.01000000', '249.98290000', 1722185999999, '16918125.68584220', 23482, '106.49755000', '7207812.01220320', '0'], [1722186000000, '67680.01000000', '67998.42000000', '67680.00000000', '67988.47000000', '309.88669000', 1722189599999, '21023356.89076620', 54469, '175.66541000', '11916555.59643430', '0'], [1722189600000, '67988.47000000', '68318.43000000', '67939.81000000', '68236.01000000', '608.47713000', 1722193199999, '41476780.69169460', 44626, '362.66472000', '24722770.66035480', '0'], [1722193200000, '68236.00000000', '68295.00000000', '68084.58000000', '68112.00000000', '342.16948000', 1722196799999, '23335254.60803330', 32272, '153.40825000', '10462492.84983060', '0'], [1722196800000, '68112.00000000', '68164.76000000', '67954.48000000', '68007.99000000', '221.81791000', 1722200399999, '15093595.69532690', 23098, '79.42909000', '5405237.66234870', '0'], [1722200400000, '68008.00000000', '68069.00000000', '67801.62000000', '68021.93000000', '324.46082000', 1722203999999, '22045751.42207040', 27679, '162.25021000', '11024693.67764860', '0'], [1722204000000, '68021.93000000', '68253.59000000', '67941.94000000', '68010.24000000', '421.43621000', 1722207599999, '28688133.96113140', 38593, '176.05621000', '11985749.88551430', '0'], [1722207600000, '68010.23000000', '68277.83000000', '67956.00000000', '68249.88000000', '236.66400000', 1722211199999, '16125061.12545500', 23446, '120.46733000', '8207549.01912250', '0'], [1722211200000, '68249.88000000', '68999.00000000', '68168.00000000', '68714.01000000', '1541.58518000', 1722214799999, '105950500.76234130', 92312, '850.76909000', '58467945.45154290', '0'], [1722214800000, '68714.01000000', '68833.33000000', '68349.49000000', '68547.99000000', '631.12401000', 1722218399999, '43306228.68435890', 51343, '297.72234000', '20427582.11937070', '0'], [1722218400000, '68548.00000000', '69635.14000000', '68533.45000000', '69559.00000000', '2595.72315000', 1722221999999, '179948028.17611560', 114294, '1471.09153000', '101955163.27375640', '0'], [1722222000000, '69558.99000000', '69800.00000000', '69302.00000000', '69347.67000000', '1204.99131000', 1722225599999, '83759404.46620650', 70348, '611.84104000', '42541939.55388480', '0'], [1722225600000, '69347.66000000', '69475.65000000', '69263.07000000', '69368.00000000', '752.39426000', 1722229199999, '52182391.53202550', 41479, '407.00283000', '28230992.79863210', '0'], [1722229200000, '69367.99000000', '69800.00000000', '69367.99000000', '69662.07000000', '1284.50311000', 1722232799999, '89389092.95402250', 55941, '804.70782000', '55991819.81128030', '0'], [1722232800000, '69662.07000000', '69888.00000000', '69551.00000000', '69588.01000000', '1097.84452000', 1722236399999, '76531086.29681070', 62687, '562.70617000', '39233821.71306500', '0'], [1722236400000, '69588.01000000', '69611.30000000', '69446.00000000', '69528.01000000', '1011.61388000', 1722239999999, '70329008.18106060', 60010, '453.92514000', '31558010.92783000', '0'], [1722240000000, '69528.01000000', '69700.00000000', '69375.00000000', '69457.50000000', '656.77325000', 1722243599999, '45665176.16505200', 40821, '316.78619000', '22026055.21114450', '0'], [1722243600000, '69457.51000000', '69618.90000000', '69440.00000000', '69520.00000000', '713.20072000', 1722247199999, '49570381.08087360', 37149, '354.15244000', '24614912.53603820', '0'], [1722247200000, '69520.00000000', '69743.07000000', '69378.80000000', '69620.00000000', '743.84688000', 1722250799999, '51750653.78763630', 43763, '365.31577000', '25417278.85070510', '0'], [1722250800000, '69620.00000000', '69838.62000000', '69580.00000000', '69580.01000000', '900.06669000', 1722254399999, '62760903.99326870', 46888, '469.95025000', '32770700.41791780', '0'], [1722254400000, '69580.01000000', '69950.00000000', '69396.74000000', '69799.38000000', '1451.28526000', 1722257999999, '101110500.40987900', 70099, '696.80661000', '48564714.70170800', '0'], [1722258000000, '69799.37000000', '70079.99000000', '69737.37000000', '69744.00000000', '2193.67763000', 1722261599999, '153384673.80238970', 63990, '1480.00626000', '103503366.53288650', '0']]

        df = pd.DataFrame(kline, columns=['start_time', 'open', 'high', 'low', 'close', 'vol', 'end_time', 'amount', 'num', '1', '2', '3'])
        df_rsi = calculate_rsi(df, rsi_calculate_cycle)
        if hit_feature(df_rsi):
            print(symbol)
